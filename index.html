<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#2d5016">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <title>Golf Round Analyzer ⛳ v9</title>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Bebas+Neue&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --green-primary: #2d5016;
      --green-secondary: #4a7c23;
      --green-light: #7fb069;
      --cream: #fffbf3;
      --sand: #e5dcc5;
      --brown: #5c4a3a;
      --red: #c44536;
      --blue: #4a90e2;
      --shadow: 0 4px 12px rgba(0,0,0,0.1);
      --nav-h: 60px; /* bottom nav 높이 */
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: linear-gradient(to bottom, var(--cream) 0%, var(--sand) 100%);
      color: var(--brown);
      -webkit-font-smoothing: antialiased;
      margin: 0;
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    #app {
      max-width: 600px;
      margin: 0 auto;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* ========== PAGE CONTAINER ========== */
    .page-container {
      height: calc(100vh - var(--nav-h));
      display: flex;
      flex-direction: column;
      padding: 2vh 4vw;
      overflow: hidden; /* 기본: 스크롤 없음 */
    }

    /* 스크롤이 필요한 페이지용 */
    .page-container.scrollable {
      overflow-y: auto;
      padding-bottom: 2vh;
    }

    /* ========== BACK BUTTON ========== */
    .back-button {
      position: fixed;
      top: 16px;
      left: 16px;
      width: 36px;
      height: 36px;
      background: white;
      border: 2px solid var(--green-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow);
      z-index: 999;
      font-size: 18px;
      color: var(--green-primary);
      transition: all 0.2s;
    }

    .back-button:hover {
      background: var(--green-primary);
      color: white;
    }

    /* ========== PAGE TITLE ========== */
    .page-title {
      font-size: clamp(20px, 3vh, 28px);
      font-weight: 700;
      color: var(--green-primary);
      margin-bottom: 1.5vh;
      font-family: 'Bebas Neue', cursive;
      letter-spacing: 1px;
      text-align: center;
      flex-shrink: 0;
    }

    /* ========== SECTION ========== */
    .section {
      background: white;
      padding: clamp(12px, 2vh, 20px) clamp(14px, 3vw, 20px);
      border-radius: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 1.5vh;
      flex-shrink: 0;
    }

    /* 홈 페이지의 메인 섹션 (flex grow로 남은 공간 채움) */
    .section.grow {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 0;
    }

    .section-title {
      font-size: clamp(14px, 2vh, 18px);
      font-weight: 600;
      color: var(--green-primary);
      margin-bottom: 1vh;
      flex-shrink: 0;
    }

    /* ========== SHOT HEADER ========== */
    .shot-header {
      background: white;
      padding: clamp(8px, 1.2vh, 14px) clamp(10px, 2vw, 16px);
      border-radius: 12px;
      margin-bottom: 1vh;
      box-shadow: var(--shadow);
      flex-shrink: 0;
    }

    .shot-info {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .hole-num {
      font-size: clamp(14px, 2vh, 16px);
      font-weight: 600;
      color: var(--green-primary);
    }

    .tee-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      background: var(--blue);
      color: white;
    }

    .tee-badge.white {
      background: #888;
    }

    .distance-badge {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 12px;
      background: var(--sand);
      color: var(--brown);
    }

    .shot-number {
      font-size: clamp(15px, 2vh, 18px);
      font-weight: 700;
      color: var(--green-primary);
      margin-top: 2px;
    }

    /* ========== PREVIOUS SHOTS ========== */
    .previous-shots {
      background: var(--sand);
      padding: clamp(6px, 1vh, 10px) clamp(8px, 1.5vw, 12px);
      border-radius: 8px;
      margin-bottom: 1vh;
      font-size: 13px;
      flex-shrink: 0;
    }

    .prev-shot { margin-bottom: 3px; opacity: 0.8; }
    .prev-shot:last-child { margin-bottom: 0; }

    /* ========== INPUT SECTIONS ========== */
    .input-section {
      margin-bottom: clamp(6px, 1.2vh, 14px);
    }

    .input-section label {
      display: block;
      font-size: clamp(13px, 1.8vh, 15px);
      font-weight: 600;
      color: var(--brown);
      margin-bottom: clamp(4px, 0.7vh, 8px);
    }

    .optional-label {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.6;
    }

    .text-input {
      width: 100%;
      padding: clamp(8px, 1.3vh, 12px);
      border: 2px solid var(--sand);
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .text-input:focus {
      outline: none;
      border-color: var(--green-primary);
    }

    /* 거리 입력 화살표 제거 */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }

    .select-input {
      width: 100%;
      padding: clamp(8px, 1.3vh, 12px);
      border: 2px solid var(--sand);
      border-radius: 8px;
      font-size: 16px;
      font-family: 'Noto Sans KR', sans-serif;
      background: white;
    }

    /* ========== BUTTONS ========== */
    .primary-btn {
      width: 100%;
      padding: clamp(12px, 2vh, 18px);
      background: var(--green-primary);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: clamp(15px, 2vh, 17px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .primary-btn:hover { background: var(--green-secondary); }
    .primary-btn:disabled { background: #ccc; cursor: not-allowed; }

    .secondary-btn {
      width: 100%;
      padding: clamp(10px, 1.6vh, 16px);
      background: white;
      color: var(--green-primary);
      border: 2px solid var(--green-primary);
      border-radius: 12px;
      font-size: clamp(14px, 1.9vh, 16px);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0;
      flex-shrink: 0;
    }

    .secondary-btn:hover {
      background: var(--green-light);
      color: white;
    }

    .button-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(6px, 1vh, 10px);
    }

    .button-group-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: clamp(6px, 1vh, 10px);
    }

    .choice-btn {
      padding: clamp(8px, 1.3vh, 12px) 4px;
      background: white;
      border: 2px solid var(--sand);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
    }

    .choice-btn:hover { border-color: var(--green-light); }

    .choice-btn.selected {
      background: var(--green-primary);
      color: white;
      border-color: var(--green-primary);
    }

    /* ========== CHECKBOX GROUP ========== */
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(5px, 0.8vh, 8px);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: clamp(6px, 1vh, 10px);
      background: white;
      border: 2px solid var(--sand);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
    }

    .checkbox-label:hover { border-color: var(--green-light); }

    .checkbox-label.selected {
      background: var(--green-primary);
      color: white;
      border-color: var(--green-primary);
    }

    .checkbox-label input[type="checkbox"] { display: none; }

    /* ========== INFO BOXES ========== */
    .club-recommendation {
      background: #e3f2fd;
      border-left: 4px solid var(--blue);
      padding: clamp(6px, 1vh, 10px) clamp(8px, 1.5vw, 12px);
      margin-bottom: 1vh;
      border-radius: 4px;
      font-size: 13px;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid var(--blue);
      padding: clamp(6px, 1vh, 10px) clamp(8px, 1.5vw, 12px);
      margin-bottom: 1vh;
      border-radius: 4px;
      font-size: 13px;
    }

    /* ========== BOTTOM NAVIGATION ========== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 600px;
      margin: 0 auto;
      height: var(--nav-h);
      background: white;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      border-top: 1px solid var(--sand);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.05);
      z-index: 1000;
    }

    .nav-btn {
      border: none;
      background: transparent;
      padding: 10px 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--brown);
      opacity: 0.6;
    }

    .nav-btn.active { color: var(--green-primary); opacity: 1; }
    .nav-btn-icon { font-size: 22px; }
    .nav-btn-label { font-size: 11px; font-weight: 500; }

    /* ========== STATS ========== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(8px, 1.5vh, 14px);
      flex: 1;
      min-height: 0;
    }

    .stat-card {
      background: white;
      padding: clamp(10px, 1.8vh, 18px) 8px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .stat-icon { font-size: clamp(22px, 3.5vh, 30px); margin-bottom: 4px; }
    .stat-label { font-size: 12px; color: var(--brown); opacity: 0.7; margin-bottom: 4px; }
    .stat-value { font-size: clamp(20px, 3vh, 26px); font-weight: 700; color: var(--green-primary); }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0.6;
    }

    .empty-state p { margin-bottom: 8px; }

    /* ========== ROUNDS LIST ========== */
    .rounds-list {
      display: flex;
      flex-direction: column;
      gap: clamp(8px, 1.2vh, 12px);
    }

    .round-card {
      background: white;
      padding: clamp(10px, 1.5vh, 16px);
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .round-header-info h3 { font-size: 15px; color: var(--green-primary); margin-bottom: 3px; }
    .round-date { font-size: 12px; opacity: 0.6; }
    .round-score-info { text-align: right; }
    .total-score { font-size: clamp(22px, 3vh, 28px); font-weight: 700; color: var(--green-primary); }

    /* ========== CLUB LIST ========== */
    .club-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: clamp(5px, 0.8vh, 8px);
    }

    .club-item {
      padding: clamp(6px, 1vh, 10px) 8px;
      background: var(--sand);
      border-radius: 8px;
      font-size: 13px;
    }

    /* ========== MODAL ========== */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }

    .modal.active { display: flex; }

    .modal-content {
      background: white;
      padding: 16px;
      border-radius: 16px;
      max-width: 480px;
      width: 94%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-title { font-size: 20px; font-weight: 700; color: var(--green-primary); }

    .close-btn {
      font-size: 26px;
      font-weight: bold;
      color: var(--brown);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: 32px;
      height: 32px;
    }

    /* ========== COURSE SELECTION ========== */
    .course-btn {
      width: 100%;
      padding: clamp(10px, 1.5vh, 16px);
      background: white;
      border: 2px solid var(--sand);
      border-radius: 12px;
      text-align: left;
      cursor: pointer;
      margin-bottom: clamp(6px, 1vh, 12px);
      transition: all 0.2s;
    }

    .course-btn:hover { border-color: var(--green-primary); }
    .course-name { font-size: 15px; font-weight: 600; color: var(--green-primary); margin-bottom: 3px; }
    .course-details { font-size: 13px; opacity: 0.7; }

    /* ========== COURSE MANAGEMENT BUTTONS ========== */
    .btn-group { display: flex; gap: 6px; }

    .edit-btn, .delete-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .edit-btn { background: var(--blue); color: white; }
    .edit-btn:hover { background: var(--green-secondary); }
    .delete-btn { background: var(--red); color: white; }
    .delete-btn:hover { background: #a03028; }
    .course-info { flex: 1; }

    /* ========== ROUND CONTROL ========== */
    .round-control-panel {
      background: var(--sand);
      padding: clamp(8px, 1.2vh, 14px) clamp(10px, 2vw, 16px);
      border-radius: 12px;
      margin-bottom: 1vh;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .round-info { font-size: 14px; opacity: 0.8; }

    .finish-round-btn {
      padding: 8px 14px;
      background: var(--red);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ========== COURSE REGISTRATION (modal) ========== */
    .hole-row {
      display: grid;
      grid-template-columns: 30px 55px 55px 80px 80px;
      gap: 5px;
      margin-bottom: 6px;
      align-items: center;
    }

    .hole-number { text-align: center; font-weight: 600; color: var(--green-primary); font-size: 13px; }

    .hole-row select,
    .hole-row input[type="number"] {
      padding: 6px 3px;
      border: 2px solid var(--sand);
      border-radius: 6px;
      font-size: 13px;
      width: 100%;
      text-align: center;
    }

    .par-summary {
      background: var(--sand);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .par-summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 13px; }
    .par-summary-row:last-child { margin-bottom: 0; }
    .par-summary-row.total { font-weight: 600; padding-top: 5px; border-top: 1px solid var(--brown); opacity: 0.3; }

    .section-divider { border-top: 2px solid var(--sand); margin: 12px 0; padding-top: 10px; }

    .subsection-title { font-size: 14px; font-weight: 600; color: var(--green-primary); margin-bottom: 10px; }

    .holes-header {
      display: grid;
      grid-template-columns: 30px 55px 55px 80px 80px;
      gap: 5px;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 11px;
      color: var(--green-primary);
      text-align: center;
    }

    /* ========== HOME QUICK ACTIONS (2열) ========== */
    .home-quick-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(6px, 1vh, 10px);
    }

    .home-quick-actions .secondary-btn { margin-bottom: 0; }

    /* ========== SCORECARD UPLOAD OVERLAY ========== */
    .upload-loading-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      color: white;
      font-size: 18px;
      gap: 20px;
    }
    .upload-loading-overlay.active { display: flex; }
    .upload-spinner {
      width: 56px; height: 56px;
      border: 5px solid rgba(255,255,255,0.2);
      border-top-color: #7fb069;
      border-radius: 50%;
      animation: spinLoader 0.8s linear infinite;
    }
    @keyframes spinLoader { to { transform: rotate(360deg); } }
    .upload-loading-text { text-align: center; }
    .upload-loading-text p { margin: 4px 0; }
    .upload-loading-text .sub { opacity: 0.6; font-size: 14px; }   
  /* 라운드 방식 선택 버튼 간격 */
  .round-type-buttons {
    display: flex;
    flex-direction: column;
    gap: 30px;
  }

  
    .hole-row.totals-row {
      background: rgba(255,255,255,0.6);
      border: 2px solid var(--sand);
      border-radius: 8px;
      padding: 6px 6px;
      margin: 10px 0 12px;
      font-weight: 700;
    }
    .hole-row.totals-row .totals-label {
      font-size: 12px;
      color: var(--green-primary);
      text-align: center;
    }
    .hole-row.totals-row .totals-cell {
      font-size: 12px;
      text-align: center;
      color: var(--brown);
    }
    
    /* totals-row variants to match desired layout */
    .hole-row.totals-row.total {
      background: var(--sand);
      border-color: rgba(92,74,58,0.25);
    }
.input-error {
      border-color: var(--red) !important;
      background: #fff2f0 !important;
    }
    .validation-msg {
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      background: rgba(196,69,54,0.10);
      border: 1px solid rgba(196,69,54,0.25);
      color: var(--red);
      font-size: 13px;
      line-height: 1.3;
      display: none;
    }

  
    /* ========== HOME (NEW TILE LAYOUT) ========== */
    .home-shell{
      background: rgba(255,255,255,0.65);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: clamp(14px, 2vh, 20px);
      display:flex;
      flex-direction:column;
      gap: 18px;
      min-height: calc(100vh - var(--nav-h) - 24px);
      justify-content: flex-start;
    }
    .home-brand{
      text-align:center;
      padding-top: 6px;
    }
    .home-brand-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .home-flag{
      font-size: 28px;
      line-height: 1;
    }
    .home-brand-title{
      font-family: 'Bebas Neue', cursive;
      font-size: 34px;
      letter-spacing: 1px;
      color: var(--green-primary);
    }
    .home-start-btn{
      width:100%;
      border:none;
      background: var(--green-primary);
      color:white;
      border-radius: 18px;
      padding: 46px 16px;
      font-size: 28px;
      font-weight: 700;
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    .home-start-btn:hover{ background: var(--green-secondary); }
    .home-tiles{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 6px;
    }
    .home-tile{
      background:white;
      border: 3px solid var(--green-primary);
      border-radius: 18px;
      padding: 22px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 10px;
      cursor:pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .home-tile.active{ background: rgba(127,176,105,0.10); }
    .home-tile.placeholder{
      border-color: rgba(0,0,0,0.10);
      background: transparent;
      box-shadow: none;
      cursor: default;
    }
    .tile-icon{ font-size: 40px; line-height: 1; }
    .tile-label{
      font-size: 22px;
      font-weight: 700;
      color: var(--green-primary);
    }
    .home-version{
      text-align:center;
      opacity:0.55;
      font-size: 14px;
      margin-top: auto;
      padding: 10px 0 4px;
    }
    .home-resume{
      background: rgba(229,220,197,0.55);
      border: 2px solid var(--sand);
      border-radius: 14px;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .home-resume-text{ font-size: 14px; color: var(--brown); }
    .home-resume-btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: none;
      background: var(--green-primary);
      color: white;
      font-weight: 700;
      cursor: pointer;
      white-space: nowrap;
    }
    .home-resume-btn:hover{ background: var(--green-secondary); }
</style>
</head>
<body>
  <div id="app"></div>

  <input type="file" id="scorecard-upload" accept="image/*" style="display:none" onchange="handleScoreCardUpload(event)">
  <input type="file" id="scorecard-camera" accept="image/*" capture="environment" style="display:none" onchange="handleScoreCardUpload(event)">
  <div id="upload-loading" class="upload-loading-overlay">
    <div class="upload-spinner"></div>
    <div class="upload-loading-text">
      <p style="font-size:22px;">🔍 스코어카드 분석 중...</p>
      <p class="sub">잠깐만 기다려주세요</p>
    </div>
  </div>


  <script>
    // ========================================
    // DEFAULT COURSES
    // ========================================
    const DEFAULT_COURSES = [
      {
        id: 'woodville-gc',
        name: 'Woodville GC',
        location: 'Woodville',
        holes: 18,
        par: [4, 4, 3, 4, 5, 4, 3, 4, 4, 4, 4, 3, 5, 4, 4, 3, 4, 4],
        distances: {
          blue: [365, 348, 165, 375, 478, 355, 152, 368, 385, 342, 358, 158, 485, 368, 355, 148, 348, 375],
          white: [350, 335, 155, 360, 465, 340, 142, 355, 370, 330, 345, 148, 470, 355, 340, 138, 335, 360]
        }
      }
    ];

    // ========================================
    // CLUB DATA & DISTANCES
    // ========================================
    const CLUB_DISTANCES = {
      'driver': { carry: 204, total: 220, max: 230 },
      '5wood': { carry: 182, total: 198, max: 210 },
      '7wood': { carry: 170, total: 185, max: 195 },
      '4iron': { carry: 165, total: 177, max: 185 },
      '5iron': { carry: 156, total: 167, max: 175 },
      '6iron': { carry: 147, total: 155, max: 165 },
      '7iron': { carry: 137, total: 144, max: 155 },
      '8iron': { carry: 127, total: 135, max: 145 },
      '9iron': { carry: 116, total: 123, max: 135 },
      'pw': { carry: 105, total: 112, max: 125 },
      'aw': { carry: 98, total: 100, max: 115 },
      '52': { carry: 88, total: 90, max: 105 },
      '56': { carry: 81, total: 83, max: 95 },
      '60': { carry: 72, total: 73, max: 85 }
    };

    const CLUBS = [
      { id: 'driver', name: '드라이버' },
      { id: '5wood', name: '5W' },
      { id: '7wood', name: '7W' },
      { id: '4iron', name: '4I' },
      { id: '5iron', name: '5I' },
      { id: '6iron', name: '6I' },
      { id: '7iron', name: '7I' },
      { id: '8iron', name: '8I' },
      { id: '9iron', name: '9I' },
      { id: 'pw', name: 'PW' },
      { id: 'aw', name: 'AW' },
      { id: '52', name: '52°' },
      { id: '56', name: '56°' },
      { id: '60', name: '60°' }
    ];

    // ========================================
    // APP STATE
    // ========================================
    const appState = {
      currentPage: 0,
      pageHistory: [0],
      data: {
        rounds: [],
        courses: [...DEFAULT_COURSES]
      },
      activeRound: null,
      currentHole: 1,
      selectedTeeBox: 'blue',
      holePar: null,
      holeDistance: '',
      shots: [],
      currentShot: null,
      puttingData: null,
      showCourseModal: false,
      showRoundSummaryModal: false,
      newCourse: null,
      editingCourse: null,
      isNewCourseRound: false, // 새 코스 라운드 플래그
      newCourseData: null // 새 코스 빌드업 데이터
    };
    // ========================================
    // SAFETY: Prevent blank screen on runtime errors
    // ========================================
    window.addEventListener('error', (e) => {
      console.error('Runtime error:', e.error || e.message);
      const root = document.getElementById('app');
      if (root && !root.dataset.crashed) {
        root.dataset.crashed = '1';
        root.innerHTML = `
          <div style="padding:16px;">
            <div style="font-size:18px;font-weight:700;margin-bottom:8px;">오류가 발생했습니다</div>
            <div style="font-size:13px;opacity:0.9;line-height:1.4;">
              화면이 비어 보이는 현상을 방지하기 위해 오류 화면을 표시했습니다.<br>
              새로고침 후 다시 시도해 주세요.
            </div>
            <button style="margin-top:14px;padding:10px 14px;border-radius:10px;border:2px solid #2d5016;background:#fff;cursor:pointer;"
              onclick="location.reload()">새로고침</button>
          </div>
        `;
      }
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled rejection:', e.reason);
    });


    // ========================================
    // LOCAL STORAGE
    // ========================================
    function saveData() {
      try {
        localStorage.setItem('golfAnalyzerV9', JSON.stringify(appState.data));
      } catch (e) {
        console.error('저장 실패:', e);
        alert('데이터 저장에 실패했습니다. 로컬 서버(VS Code Live Server 등)로 실행해주세요.');
      }
    }

    function loadData() {
      try {
        const saved = localStorage.getItem('golfAnalyzerV9');
        if (saved) {
          appState.data = JSON.parse(saved);

          // ✅ Backward-compat: ensure strokeIndex exists on all courses
          if (appState.data && Array.isArray(appState.data.courses)) {
            appState.data.courses.forEach(c => {
              if (!c.strokeIndex || !Array.isArray(c.strokeIndex)) {
                const holes = c.holes || (c.par ? c.par.length : 18) || 18;
                c.strokeIndex = Array.from({length: holes}, (_, i) => i + 1);
              }
            });
          }
        }
      } catch (e) {
        console.error('불러오기 실패:', e);
      }
    }

    // ========================================
    // AI CLUB RECOMMENDATION
    // ========================================
    function getRecommendedClub(distance) {
      if (!distance) return null;
      
      const dist = parseInt(distance);
      let bestClub = null;
      let minDiff = Infinity;

      CLUBS.forEach(club => {
        const clubDist = CLUB_DISTANCES[club.id];
        if (clubDist && clubDist.total > 0) {
          const diff = Math.abs(clubDist.total - dist);
          if (diff < minDiff) {
            minDiff = diff;
            bestClub = club;
          }
        }
      });

      return bestClub;
    }

    // ========================================
    // RENDER MAIN
    // ========================================
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = '';

      const container = document.createElement('div');
      container.className = 'page-container';

      // 라운드 진행 중인 경우
      if (appState.activeRound) {
        // 뒤로가기 버튼 추가
        const backBtn = document.createElement('button');
        backBtn.className = 'back-button';
        backBtn.innerHTML = '←';
        backBtn.onclick = goBack;
        app.appendChild(backBtn);

        if (appState.puttingData) {
          renderPuttingInput(container);
        } else if (appState.currentShot) {
          renderShotInput(container);
        } else {
          // Par 입력 화면 또는 샷 시작 대기
          renderParInput(container);
        }
      } else {
        // 일반 페이지
        switch (appState.currentPage) {
          case 0: renderHomePage(container); break;
          case 1: renderRoundStartPage(container); break;
          case 2: renderStatsPage(container); break;
          case 3: renderHistoryPage(container); break;
          case 4: renderSettingsPage(container); break;
        }
      }

      app.appendChild(container);

      // 라운드 진행 중이 아닐 때만 하단 네비게이션 표시
      if (!appState.activeRound) {
        // 홈이 아닌 페이지에서 백버튼 표시
        if (appState.currentPage !== 0) {
          const backBtn = document.createElement('button');
          backBtn.className = 'back-button';
          backBtn.innerHTML = '&#8592;';
          backBtn.onclick = function() {
            if (appState.pageHistory.length > 0) {
              appState.currentPage = appState.pageHistory.pop();
            } else {
              appState.currentPage = 0;
            }
            render();
          };
          app.appendChild(backBtn);
        }
        if (appState.currentPage !== 0) app.appendChild(renderBottomNav());
      }

      // 모달 렌더링
      if (appState.showCourseModal) {
        app.appendChild(renderCourseModal());
      }
      if (appState.showRoundSummaryModal) {
        app.appendChild(renderRoundSummaryModal());
      }
    }

    // ========================================
    // BACK BUTTON
    // ========================================
    function goBack() {
      if (appState.puttingData) {
        // 퍼팅 입력 -> 샷 입력으로
        appState.puttingData = null;
        if (appState.shots.length > 0) {
          appState.currentShot = appState.shots.pop();
        }
      } else if (appState.currentShot) {
        // 샷 입력 -> 이전 샷 또는 Par 입력으로
        if (appState.shots.length > 0) {
          appState.currentShot = appState.shots.pop();
        } else {
          appState.currentShot = null;
          appState.holePar = null;
        }
      } else if (appState.holePar) {
        // Par 입력 -> 라운드 취소 확인
        if (confirm('라운드를 취소하시겠습니까?')) {
          cancelRound();
        }
      }
      render();
    }

    function cancelRound() {
      appState.activeRound = null;
      appState.currentHole = 1;
      appState.holePar = null;
      appState.holeDistance = '';
      appState.shots = [];
      appState.currentShot = null;
      appState.puttingData = null;
      appState.isNewCourseRound = false;
      appState.newCourseData = null;
      appState.currentPage = 0;
    }

    // ========================================
    // BOTTOM NAVIGATION
    // ========================================
    function renderBottomNav() {
      const nav = document.createElement('nav');
      nav.className = 'bottom-nav';

      const pages = [
        { icon: '🏠', label: '홈', pageIndex: 0 },
        { icon: '⛳', label: '라운드', pageIndex: 1 },
        { icon: '⚙️', label: '설정', pageIndex: 4 }
      ];

      pages.forEach((page, index) => {
        const btn = document.createElement('button');
        btn.className = `nav-btn ${appState.currentPage === page.pageIndex ? 'active' : ''}`;
        btn.innerHTML = `
          <div class="nav-btn-icon">${page.icon}</div>
          <div class="nav-btn-label">${page.label}</div>
        `;
        btn.onclick = () => {
          appState.pageHistory.push(appState.currentPage);
          appState.currentPage = page.pageIndex;
          render();
        };
        nav.appendChild(btn);
      });

      return nav;
    }

    // ========================================
    // HOME PAGE
    // ========================================
    function renderHomePage(container) {
      const inProgressRound = appState.data.rounds.find(r => r.status === 'in-progress');

      container.classList.add('scrollable');
      container.innerHTML = `
        <div class="home-shell">
          <div class="home-brand">
            <div class="home-brand-row">
              <div class="home-flag">⛳</div>
              <div class="home-brand-title">GOLF ROUND ANALYZER</div>
            </div>
          </div>

          ${inProgressRound ? `
            <div class="home-resume">
              <div class="home-resume-text">
                진행 중: <b>${inProgressRound.course}</b> • ${inProgressRound.holes.length}/18 홀
              </div>
              <button class="home-resume-btn" onclick="resumeRound()">계속하기</button>
            </div>
          ` : ''}

          <button class="home-start-btn" onclick="goToPage(1)">
            🏌️ 새 라운드 시작
          </button>

          <div class="home-tiles">
            <button class="home-tile active" onclick="goToPage(0)">
              <div class="tile-icon">🏠</div>
              <div class="tile-label">홈</div>
            </button>

            <button class="home-tile" onclick="goToPage(1)">
              <div class="tile-icon">⛳</div>
              <div class="tile-label">라운드</div>
            </button>

            <button class="home-tile" onclick="goToPage(2)">
              <div class="tile-icon">📊</div>
              <div class="tile-label">통계</div>
            </button>

            <button class="home-tile" onclick="goToPage(3)">
              <div class="tile-icon">📋</div>
              <div class="tile-label">기록</div>
            </button>

            <div class="home-tile placeholder" aria-hidden="true"></div>

            <button class="home-tile" onclick="goToPage(4)">
              <div class="tile-icon">⚙️</div>
              <div class="tile-label">설정</div>
            </button>
          </div>

          <div class="home-version">v9.0.0 • Par 입력 개선</div>
        </div>
      `;
    }
window.goToPage = function(page) {
      appState.pageHistory.push(appState.currentPage);
      appState.currentPage = page;
      render();
    };

    window.resumeRound = function() {
      const inProgressRound = appState.data.rounds.find(r => r.status === 'in-progress');
      if (inProgressRound) {
        appState.data.rounds = appState.data.rounds.filter(r => r.status !== 'in-progress');
        appState.activeRound = inProgressRound;
        appState.currentHole = inProgressRound.holes.length + 1;
        appState.selectedTeeBox = inProgressRound.teeBox;
        render();
      }
    };

    // ========================================
    // ROUND START PAGE (NEW - 코스 선택 / 새 코스)
    // ========================================
    function renderRoundStartPage(container) {
      container.innerHTML = `
        <h1 class="page-title">⛳ 새 라운드</h1>
        
        <div class="section grow" style="justify-content:center;">
          <h2 class="section-title">라운드 방식 선택</h2>
          
          <div class="round-type-buttons">
            <button class="secondary-btn" onclick="selectRoundType('existing')">
              📋 코스 선택 (등록된 코스)
            </button>
            
            <button class="secondary-btn" onclick="selectRoundType('new')">
              ➕ 새 코스 (라운드하면서 등록)
            </button>
          </div>
        </div>
      `;
    }


    window.selectRoundType = function(type) {
      if (type === 'existing') {
        appState.currentPage = 10; // 기존 코스 선택 페이지
      } else {
        appState.currentPage = 11; // 새 코스 입력 페이지
      }
      render();
    };

    // ========================================
    // EXISTING COURSE SELECTION PAGE
    // ========================================
    function renderExistingCourseSelectionPage(container) {
      container.innerHTML = `
        <h1 class="page-title">코스 선택</h1>
        
        <div class="section grow" style="justify-content:center;">
          <h2 class="section-title">등록된 코스</h2>
          
          ${appState.data.courses.map(course => {
            const totalPar = course.par.reduce((a,b) => a+b, 0);
            
            return `
              <button class="course-btn" onclick="selectExistingCourse('${course.id}')">
                <div class="course-name">${course.name}</div>
                <div class="course-details">
                  ${course.location} • ${course.holes}홀 • Par ${totalPar}
                </div>
              </button>
            `;
          }).join('')}
        </div>
      `;
    }

    window.selectExistingCourse = function(courseId) {
      appState.selectedCourseId = courseId;
      appState.currentPage = 12; // 티박스 선택 페이지
      render();
    };

    // ========================================
    // TEEBOX SELECTION PAGE
    // ========================================
    function renderTeeboxSelectionPage(container) {
      const course = appState.data.courses.find(c => c.id === appState.selectedCourseId);

      container.innerHTML = `
        <h1 class="page-title">티박스 선택</h1>
        
        <div class="section">
          <h2 class="section-title">${course.name}</h2>
          
          <div class="button-group">
            <button class="choice-btn ${appState.selectedTeeBox === 'blue' ? 'selected' : ''}" 
              onclick="selectTeeBoxAndStart('blue')">
              🔵 Blue
            </button>
            <button class="choice-btn ${appState.selectedTeeBox === 'white' ? 'selected' : ''}" 
              onclick="selectTeeBoxAndStart('white')">
              ⚪ White
            </button>
          </div>
        </div>
      `;
    }

    window.selectTeeBoxAndStart = function(teeBox) {
      const course = appState.data.courses.find(c => c.id === appState.selectedCourseId);
      if (course) {
        appState.selectedTeeBox = teeBox;
        appState.activeRound = {
          id: Date.now(),
          courseId: course.id,
          course: course.name,
          teeBox: teeBox,
          date: new Date().toISOString(),
          holes: [],
          status: 'in-progress'
        };
        appState.currentHole = 1;
        appState.isNewCourseRound = false;
        render();
      }
    };

    // ========================================
    // NEW COURSE INPUT PAGE
    // ========================================
    function renderNewCourseInputPage(container) {
      container.innerHTML = `
        <h1 class="page-title">새 코스</h1>
        
        <div class="section grow" style="justify-content:center;">
          <h2 class="section-title">코스 정보</h2>
          
          <div class="input-section">
            <label>코스 이름</label>
            <input type="text" class="text-input" id="new-course-name"
              placeholder="예: 스카이72 오션">
          </div>

          <div class="input-section">
            <label>티박스 선택</label>
            <div class="button-group">
              <button class="choice-btn ${appState.selectedTeeBox === 'blue' ? 'selected' : ''}" 
                onclick="selectNewCourseTeeBox('blue')">
                🔵 Blue
              </button>
              <button class="choice-btn ${appState.selectedTeeBox === 'white' ? 'selected' : ''}" 
                onclick="selectNewCourseTeeBox('white')">
                ⚪ White
              </button>
            </div>
          </div>

          <button class="primary-btn" onclick="startNewCourseRound()">
            라운드 시작
          </button>
        </div>
      `;
    }

    window.selectNewCourseTeeBox = function(teeBox) {
      appState.selectedTeeBox = teeBox;
      render();
    };

    window.startNewCourseRound = function() {
      const courseName = document.getElementById('new-course-name').value.trim();
      
      if (!courseName) {
        alert('코스 이름을 입력해주세요.');
        return;
      }

      appState.isNewCourseRound = true;
      appState.newCourseData = {
        id: 'course_' + Date.now(),
        name: courseName,
        location: '', // 나중에 추가 가능
        holes: 18,
        par: [],
        distances: {
          blue: [],
          white: []
        }
      };

      appState.activeRound = {
        id: Date.now(),
        courseId: 'new_course',
        course: courseName,
        teeBox: appState.selectedTeeBox,
        date: new Date().toISOString(),
        holes: [],
        status: 'in-progress'
      };
      
      appState.currentHole = 1;
      render();
    };

    // ========================================
    // COURSE REGISTRATION MODAL
    // ========================================
    window.openCourseRegistration = function() {
      appState.newCourse = {
        id: 'course_' + Date.now(),
        name: '',
        location: '',
        holes: 18,
        par: new Array(18).fill(4),
        strokeIndex: Array.from({length: 18}, (_, i) => i + 1),
        distances: {
          blue: new Array(18).fill(0),
          white: new Array(18).fill(0)
        }
      };
      appState.showCourseModal = true;
      render();
    };

    window.openCourseEdit = function(courseId) {
      const course = appState.data.courses.find(c => c.id === courseId);
      if (course) {
        appState.newCourse = JSON.parse(JSON.stringify(course));
        if (!appState.newCourse.strokeIndex || !Array.isArray(appState.newCourse.strokeIndex)) {
          appState.newCourse.strokeIndex = Array.from({length: appState.newCourse.holes || 18}, (_, i) => i + 1);
        }
        appState.editingCourse = courseId;
        appState.showCourseModal = true;
        render();
      }
    };

    window.closeCourseModal = function() {
      appState.showCourseModal = false;
      appState.newCourse = null;
      appState.editingCourse = null;
      render();
    };

    function renderCourseModal() {
  const modal = document.createElement('div');
  modal.className = 'modal active';

  const course = appState.newCourse;
  const holes = course.holes || 18;

  const outPar = course.par.slice(0, 9).reduce((a,b) => a+b, 0);
  const inPar = holes === 18 ? course.par.slice(9, 18).reduce((a,b) => a+b, 0) : 0;
  const totalPar = course.par.slice(0, holes).reduce((a,b) => a+b, 0);

  const outDistBlue = course.distances.blue.slice(0, 9).reduce((a,b) => a+b, 0);
  const inDistBlue = holes === 18 ? course.distances.blue.slice(9, 18).reduce((a,b) => a+b, 0) : 0;
  const totalDistBlue = course.distances.blue.slice(0, holes).reduce((a,b) => a+b, 0);

  const outDistWhite = course.distances.white.slice(0, 9).reduce((a,b) => a+b, 0);
  const inDistWhite = holes === 18 ? course.distances.white.slice(9, 18).reduce((a,b) => a+b, 0) : 0;
  const totalDistWhite = course.distances.white.slice(0, holes).reduce((a,b) => a+b, 0);

  const validation = validateCourse(course);

  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">${appState.editingCourse ? '코스 수정' : '새 코스 등록'}</h2>
        <button class="close-btn" onclick="closeCourseModal()">&times;</button>
      </div>

      <div class="input-section">
        <label>코스명</label>
        <input type="text" class="text-input"
          value="${course.name}"
          oninput="updateNewCourseNoRender('name', this.value)"
          placeholder="예: 스카이72 오션">
      </div>

      <div class="input-section">
        <label>위치</label>
        <input type="text" class="text-input"
          value="${course.location}"
          oninput="updateNewCourseNoRender('location', this.value)"
          placeholder="예: 인천">
      </div>

      <div class="input-section">
        <label>홀 수</label>
        <select class="select-input" value="${holes}"
          onchange="updateNewCourse('holes', parseInt(this.value))">
          <option value="9" ${holes === 9 ? 'selected' : ''}>9홀</option>
          <option value="18" ${holes === 18 ? 'selected' : ''}>18홀</option>
        </select>
      </div>

      <div class="subsection-title">Out (1-9홀)</div>

      <div class="holes-header">
        <div>홀</div>
        <div>Par</div>
        <div>Index</div>
        <div>Blue(m)</div>
        <div>White(m)</div>
      </div>

      ${course.par.slice(0, Math.min(9, holes)).map((par, i) => `
        <div class="hole-row">
          <div class="hole-number">${i+1}</div>
          <select onchange="updateHoleParNoRender(${i}, parseInt(this.value))">
            <option value="3" ${par === 3 ? 'selected' : ''}>3</option>
            <option value="4" ${par === 4 ? 'selected' : ''}>4</option>
            <option value="5" ${par === 5 ? 'selected' : ''}>5</option>
          </select>
          <input type="number" min="1" max="36" step="1" id="idx-${i}"
            value="${course.strokeIndex && course.strokeIndex[i] ? course.strokeIndex[i] : ''}"
            oninput="handleStrokeIndexInput(${i}, this.value)"
            placeholder="Idx">
          <input type="number" value="${course.distances.blue[i] || ''}"
            oninput="updateHoleDistanceNoRender(${i}, 'blue', parseInt(this.value) || 0)"
            placeholder="Blue">
          <input type="number" value="${course.distances.white[i] || ''}"
            oninput="updateHoleDistanceNoRender(${i}, 'white', parseInt(this.value) || 0)"
            placeholder="White">
        </div>
      `).join('')}

      <div class="hole-row totals-row" id="outTotalsRow">
        <div class="totals-label">OUT</div>
        <div class="totals-cell">Par ${outPar}</div>
        <div class="totals-cell">-</div>
        <div class="totals-cell">Blue ${outDistBlue}m</div>
        <div class="totals-cell">White ${outDistWhite}m</div>
      </div>

      ${holes === 18 ? `
        <div class="section-divider"></div>
        <div class="subsection-title">In (10-18홀)</div>

        <div class="holes-header">
          <div>홀</div>
          <div>Par</div>
          <div>Index</div>
          <div>Blue(m)</div>
          <div>White(m)</div>
        </div>

        ${course.par.slice(9, 18).map((par, i) => {
          const holeIdx = i + 9;
          return `
            <div class="hole-row">
              <div class="hole-number">${holeIdx + 1}</div>
              <select onchange="updateHoleParNoRender(${holeIdx}, parseInt(this.value))">
                <option value="3" ${par === 3 ? 'selected' : ''}>3</option>
                <option value="4" ${par === 4 ? 'selected' : ''}>4</option>
                <option value="5" ${par === 5 ? 'selected' : ''}>5</option>
              </select>
              <input type="number" min="1" max="36" step="1" id="idx-${holeIdx}"
                value="${course.strokeIndex && course.strokeIndex[holeIdx] ? course.strokeIndex[holeIdx] : ''}"
                oninput="handleStrokeIndexInput(${holeIdx}, this.value)"
                placeholder="Idx">
              <input type="number" value="${course.distances.blue[holeIdx] || ''}"
                oninput="updateHoleDistanceNoRender(${holeIdx}, 'blue', parseInt(this.value) || 0)"
                placeholder="Blue">
              <input type="number" value="${course.distances.white[holeIdx] || ''}"
                oninput="updateHoleDistanceNoRender(${holeIdx}, 'white', parseInt(this.value) || 0)"
                placeholder="White">
            </div>
          `;
        }).join('')}

        <div class="hole-row totals-row" id="inTotalsRow">
          <div class="totals-label">IN</div>
          <div class="totals-cell">Par ${inPar}</div>
          <div class="totals-cell">-</div>
          <div class="totals-cell">Blue ${inDistBlue}m</div>
          <div class="totals-cell">White ${inDistWhite}m</div>
        </div>

        <!-- Summary rows (keep existing OUT above; add OUT between IN and TOTAL) -->
        <div class="hole-row totals-row" id="outSummaryRow">
          <div class="totals-label">OUT</div>
          <div class="totals-cell">Par ${outPar}</div>
          <div class="totals-cell">-</div>
          <div class="totals-cell">Blue ${outDistBlue}m</div>
          <div class="totals-cell">White ${outDistWhite}m</div>
        </div>

        <div class="hole-row totals-row total" id="totalTotalsRow">
          <div class="totals-label">TOTAL</div>
          <div class="totals-cell">Par ${totalPar}</div>
          <div class="totals-cell">-</div>
          <div class="totals-cell">Blue ${totalDistBlue}m</div>
          <div class="totals-cell">White ${totalDistWhite}m</div>
        </div>
      ` : `
        <div class="hole-row totals-row total" id="totalTotalsRow">
          <div class="totals-label">TOTAL</div>
          <div class="totals-cell">Par ${totalPar}</div>
          <div class="totals-cell">-</div>
          <div class="totals-cell">Blue ${totalDistBlue}m</div>
          <div class="totals-cell">White ${totalDistWhite}m</div>
        </div>
      `}

      <div id="courseValidationMsg" class="validation-msg">${validation.message || ''}</div>

      <button id="courseSaveBtn" class="primary-btn" onclick="saveCourseAndRefresh()"
        ${!validation.ok ? 'disabled' : ''}>
        ${appState.editingCourse ? '수정 완료' : '코스 저장'}
      </button>
    </div>
  `;

  modal.onclick = (e) => {
    if (e.target === modal) closeCourseModal();
  };

  return modal;
}

    window.updateNewCourse = function(field, value) {
      appState.newCourse[field] = value;
      if (field === 'holes') {
        const holes = parseInt(value);
        appState.newCourse.par = new Array(holes).fill(4);
        appState.newCourse.strokeIndex = Array.from({length: holes}, (_, i) => i + 1);
        appState.newCourse.distances = {
          blue: new Array(holes).fill(0),
          white: new Array(holes).fill(0)
        };
      }
      render();
    };

    window.updateNewCourseNoRender = function(field, value) {
      appState.newCourse[field] = value;
      updateParSummary();
    };

    window.updateHoleParNoRender = function(index, value) {
      appState.newCourse.par[index] = value;
      updateParSummary();
    };

    window.updateHoleDistanceNoRender = function(index, teeBox, value) {
      appState.newCourse.distances[teeBox][index] = value;
      updateParSummary();
    };

    window.updateHoleIndexNoRender = function(index, value) {
      if (!appState.newCourse.strokeIndex) {
        appState.newCourse.strokeIndex = Array.from({length: appState.newCourse.holes}, (_, i) => i + 1);
      }
      appState.newCourse.strokeIndex[index] = value;
    };

    function validateCourse(course) {
      const holes = course.holes || 18;

      // Ensure strokeIndex array exists
      if (!course.strokeIndex || !Array.isArray(course.strokeIndex)) {
        course.strokeIndex = Array.from({length: holes}, (_, i) => i + 1);
      }

      const issues = [];
      const invalidIndexHoles = [];
      const indexMap = new Map(); // idx -> [holeNumbers]
      const dupIndexHoles = [];

      // Name
      if (!course.name || !course.name.trim()) {
        issues.push('코스명을 입력하세요.');
      }

      // Per-hole checks
      for (let i = 0; i < holes; i++) {
        const holeNo = i + 1;

        // Index: positive, <= 36, integer
        const idxVal = parseInt(course.strokeIndex[i], 10);
        if (!Number.isInteger(idxVal) || idxVal < 1 || idxVal > 36) {
          invalidIndexHoles.push(holeNo);
        } else {
          if (!indexMap.has(idxVal)) indexMap.set(idxVal, []);
          indexMap.get(idxVal).push(holeNo);
        }

        // Distances must be positive numbers (Blue/White)
        const b = parseInt(course.distances?.blue?.[i] ?? 0, 10);
        const w = parseInt(course.distances?.white?.[i] ?? 0, 10);
        if (!Number.isFinite(b) || b <= 0) issues.push(`Blue(m) 거리 누락: ${holeNo}번 홀`);
        if (!Number.isFinite(w) || w <= 0) issues.push(`White(m) 거리 누락: ${holeNo}번 홀`);
      }

      // Duplicates
      for (const [idx, holesArr] of indexMap.entries()) {
        if (holesArr.length > 1) {
          dupIndexHoles.push(...holesArr);
          issues.push(`Index 중복: ${idx} (홀 ${holesArr.join(', ')})`);
        }
      }

      if (invalidIndexHoles.length) {
        issues.push(`Index 범위 오류(1~36): 홀 ${invalidIndexHoles.join(', ')}`);
      }

      // Keep message short: show up to 3 issues
      const msg = issues.length ? issues.slice(0, 3).join('<br>') : '';

      const ok = issues.length === 0;

      return { ok, message: msg, invalidIndexHoles, dupIndexHoles };
    }

    function applyIndexValidationUI(validation) {
      // Clear previous styling
      const course = appState.newCourse;
      const holes = course.holes || 18;
      for (let i = 0; i < holes; i++) {
        const el = document.getElementById(`idx-${i}`);
        if (el) el.classList.remove('input-error');
      }

      // Mark invalids
      validation.invalidIndexHoles.forEach(holeNo => {
        const el = document.getElementById(`idx-${holeNo - 1}`);
        if (el) el.classList.add('input-error');
      });

      // Mark duplicates
      validation.dupIndexHoles.forEach(holeNo => {
        const el = document.getElementById(`idx-${holeNo - 1}`);
        if (el) el.classList.add('input-error');
      });

      // Message + button
      const msgEl = document.getElementById('courseValidationMsg');
      if (msgEl) {
        if (validation.message) {
          msgEl.innerHTML = validation.message;
          msgEl.style.display = 'block';
        } else {
          msgEl.innerHTML = '';
          msgEl.style.display = 'none';
        }
      }

      const btn = document.getElementById('courseSaveBtn');
      if (btn) {
        btn.disabled = !validation.ok;
      }
    }

    window.handleStrokeIndexInput = function(index, rawValue) {
      let v = parseInt(rawValue, 10);
      if (!Number.isFinite(v)) v = 0;

      // Hard clamp in state (keep within 0..36; 0 means "not set yet")
      if (v < 0) v = 0;
      if (v > 36) v = 36;

      window.updateHoleIndexNoRender(index, v);
      // Recompute derived UI and validation
      updateParSummary();
    };

    function updateParSummary() {
      const course = appState.newCourse;
      const outPar = course.par.slice(0, 9).reduce((a,b) => a+b, 0);
      const inPar = course.holes === 18 ? course.par.slice(9, 18).reduce((a,b) => a+b, 0) : 0;
      const totalPar = course.par.reduce((a,b) => a+b, 0);

      const outDistBlue = course.distances.blue.slice(0, 9).reduce((a,b) => a+b, 0);
      const inDistBlue = course.holes === 18 ? course.distances.blue.slice(9, 18).reduce((a,b) => a+b, 0) : 0;
      const totalDistBlue = course.distances.blue.reduce((a,b) => a+b, 0);

      const outDistWhite = course.distances.white.slice(0, 9).reduce((a,b) => a+b, 0);
      const inDistWhite = course.holes === 18 ? course.distances.white.slice(9, 18).reduce((a,b) => a+b, 0) : 0;
      const totalDistWhite = course.distances.white.reduce((a,b) => a+b, 0);

      const summaryElement = document.querySelector('.par-summary');
      if (summaryElement) {
        summaryElement.innerHTML = `
          <div class="par-summary-row">
            <span class="par-summary-label">Out (1-9홀):</span>
            <span class="par-summary-value">Par ${outPar} / Blue ${outDistBlue}m / White ${outDistWhite}m</span>
          </div>
          ${course.holes === 18 ? `
            <div class="par-summary-row">
              <span class="par-summary-label">In (10-18홀):</span>
              <span class="par-summary-value">Par ${inPar} / Blue ${inDistBlue}m / White ${inDistWhite}m</span>
            </div>
          ` : ''}
          <div class="par-summary-row total">
            <span class="par-summary-label">Total:</span>
            <span class="par-summary-value">Par ${totalPar} / Blue ${totalDistBlue}m / White ${totalDistWhite}m</span>
          </div>
        `;
      }

      // Update the new totals rows
      const outRow = document.getElementById('outTotalsRow');
      if (outRow) {
        const cells = outRow.querySelectorAll('.totals-cell');
        if (cells && cells.length >= 4) {
          cells[0].textContent = `Par ${outPar}`;
          cells[2].textContent = `Blue ${outDistBlue}m`;
          cells[3].textContent = `White ${outDistWhite}m`;
        }
      }


      const outSummary = document.getElementById('outSummaryRow');
      if (outSummary) {
        const cells = outSummary.querySelectorAll('.totals-cell');
        if (cells && cells.length >= 4) {
          cells[0].textContent = `Par ${outPar}`;
          cells[2].textContent = `Blue ${outDistBlue}m`;
          cells[3].textContent = `White ${outDistWhite}m`;
        }
      }

      const inRow = document.getElementById('inTotalsRow');
      if (inRow) {
        const cells = inRow.querySelectorAll('.totals-cell');
        if (cells && cells.length >= 4) {
          cells[0].textContent = `Par ${inPar}`;
          cells[2].textContent = `Blue ${inDistBlue}m`;
          cells[3].textContent = `White ${inDistWhite}m`;
        }
      }

      const totalRow = document.getElementById('totalTotalsRow');
      if (totalRow) {
        const cells = totalRow.querySelectorAll('.totals-cell');
        if (cells && cells.length >= 4) {
          cells[0].textContent = `Par ${totalPar}`;
          cells[2].textContent = `Blue ${totalDistBlue}m`;
          cells[3].textContent = `White ${totalDistWhite}m`;
        }
      }

      // Validation/UI
      const validation = validateCourse(course);
      applyIndexValidationUI(validation);
    }

    window.saveCourseAndRefresh = function() {
      if (appState.newCourse.name) {
        if (appState.editingCourse) {
          const index = appState.data.courses.findIndex(c => c.id === appState.editingCourse);
          if (index !== -1) {
            appState.data.courses[index] = {...appState.newCourse};
          }
        } else {
          appState.data.courses.push({...appState.newCourse});
        }
        saveData();
        closeCourseModal();
        render();
      }
    };

    // ========================================
    // PAR INPUT (새 코스일 때 거리도 입력)
    // ========================================
    function renderParInput(container) {
      const isNewCourse = appState.isNewCourseRound;
      const holeIndex = appState.currentHole - 1;
      
      let defaultPar = 4;
      let defaultDistance = '';
      
      // 기존 코스의 경우
      if (!isNewCourse && appState.activeRound.courseId !== 'new_course') {
        const course = appState.data.courses.find(c => c.id === appState.activeRound.courseId);
        if (course && course.par && course.par[holeIndex]) {
          defaultPar = course.par[holeIndex];
          if (course.distances && course.distances[appState.selectedTeeBox]) {
            defaultDistance = course.distances[appState.selectedTeeBox][holeIndex] || '';
          }
        }
      }

      const holesPlayed = appState.activeRound.holes.length;

      container.innerHTML = `
        <h1 class="page-title">Hole ${appState.currentHole}</h1>

        ${holesPlayed > 0 ? `
          <div class="round-control-panel">
            <div class="round-info">
              ${holesPlayed}/18 홀 완료
            </div>
            <button class="finish-round-btn" onclick="finishRoundManually()">
              라운드 종료
            </button>
          </div>
        ` : ''}
        
        <div class="section grow">
          <h2 class="section-title">홀 정보</h2>
          
          ${isNewCourse ? `
            <div class="info-box">
              💡 라운드하면서 코스 정보를 입력하세요.
            </div>
          ` : `
            <div class="info-box">
              ${defaultPar && defaultDistance ? 
                `✓ Par ${defaultPar} • ${defaultDistance}m` : 
                '💡 홀 정보를 입력하세요.'
              }
            </div>
          `}

          <div class="input-section">
            <label>Par</label>
            <div class="button-group-3">
              <button class="choice-btn ${appState.holePar === 3 || (!appState.holePar && defaultPar === 3) ? 'selected' : ''}" 
                onclick="setTempPar(3)">Par 3</button>
              <button class="choice-btn ${appState.holePar === 4 || (!appState.holePar && defaultPar === 4) ? 'selected' : ''}" 
                onclick="setTempPar(4)">Par 4</button>
              <button class="choice-btn ${appState.holePar === 5 || (!appState.holePar && defaultPar === 5) ? 'selected' : ''}" 
                onclick="setTempPar(5)">Par 5</button>
            </div>
          </div>

          <div class="input-section">
            <label>거리 (미터) ${isNewCourse ? '' : '<span class="optional-label">(직접 입력 가능)</span>'}</label>
            <input type="number" class="text-input" id="hole-distance-input"
              value="${appState.holeDistance || defaultDistance}" 
              placeholder="예: 350">
          </div>

          <button class="primary-btn" onclick="confirmParAndDistance()">
            샷 입력 시작
          </button>
        </div>
      `;

      if (!appState.holePar) appState.holePar = defaultPar;
      if (!appState.holeDistance) appState.holeDistance = defaultDistance;
    }

    window.setTempPar = function(par) {
      appState.holePar = par;
      // render() 대신 버튼 스타일만 업데이트
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
    };

    window.confirmParAndDistance = function() {
      const distanceInput = document.getElementById('hole-distance-input');
      const distance = distanceInput ? distanceInput.value : '';
      
      if (!appState.holePar) appState.holePar = 4;
      appState.holeDistance = distance;

      // 새 코스인 경우 데이터 저장
      if (appState.isNewCourseRound) {
        const holeIndex = appState.currentHole - 1;
        appState.newCourseData.par[holeIndex] = appState.holePar;
        appState.newCourseData.distances[appState.selectedTeeBox][holeIndex] = parseInt(distance) || 0;
      }

      // 샷 입력 시작
      startTeeShot();
    };

    window.finishRoundManually = function() {
      if (confirm('라운드를 종료하시겠습니까?')) {
        finishRound();
      }
    };

    function finishRound() {
      appState.activeRound.status = 'completed';
      appState.data.rounds.push(appState.activeRound);
      
      // 새 코스였다면 코스 등록
      if (appState.isNewCourseRound && appState.newCourseData) {
        // 나머지 홀 데이터 채우기 (입력 안 한 홀은 Par 4, 0m로)
        while (appState.newCourseData.par.length < 18) {
          appState.newCourseData.par.push(4);
          appState.newCourseData.distances[appState.selectedTeeBox].push(0);
        }
        
        appState.data.courses.push(appState.newCourseData);
      }
      
      saveData();
      
      appState.showRoundSummaryModal = true;
      render();
    }

    // ========================================
    // SHOT TYPE & START
    // ========================================
    function startTeeShot() {
      const isPar3 = appState.holePar === 3;
      
      appState.currentShot = {
        number: appState.shots.length + 1,
        type: 'tee',
        club: '',
        distance: isPar3 ? (appState.holeDistance || '') : null,
        shotType: null,
        result: {
          landing: '',
          shape: '',
          miss: [],
          onGreen: null,
          direction: []
        }
      };
      render();
    }

    // ========================================
    // SHOT INPUT (테스트1 피드백 완전 반영)
    // ========================================
    function renderShotInput(container) {
      container.classList.add('scrollable');
      const shot = appState.currentShot;
      const isTeeShot = shot.type === 'tee';
      const isPar3 = appState.holePar === 3;
      const isPar4or5 = appState.holePar === 4 || appState.holePar === 5;
      const isShortGame = shot.type === 'short';
      
      // Par 3는 거리 필요, Par 4/5 티샷은 거리 불필요
      const needsDistance = (isTeeShot && isPar3) || !isTeeShot;
      
      // 추천 클럽
      const recommendedClub = (needsDistance && shot.distance) ? getRecommendedClub(shot.distance) : null;

      // Par 4/5 티샷은 온그린/방향 선택 숨김
      const showGreenSelection = !(isTeeShot && isPar4or5);

      // 미스 패턴은 페어웨이가 아닐 때만
      const showMissPattern = isTeeShot && shot.result.landing && shot.result.landing !== 'fairway';

      container.innerHTML = `
        <div class="shot-header">
          <div class="shot-info">
            <span class="hole-num">Hole ${appState.currentHole} - Par ${appState.holePar}</span>
            <span class="tee-badge ${appState.selectedTeeBox}">
              ${appState.selectedTeeBox === 'blue' ? 'Blue' : 'White'}
            </span>
            ${appState.holeDistance ? `<span class="distance-badge">${appState.holeDistance}m</span>` : ''}
          </div>
          <div class="shot-number">샷 #${shot.number}${isTeeShot ? ' - 티샷' : isShortGame ? ' - 숏게임' : ' - 어프로치'}</div>
        </div>

        ${appState.shots.length > 0 ? `
          <div class="previous-shots">
            <strong>이전 샷:</strong><br>
            ${appState.shots.map((s, i) => {
              const clubName = CLUBS.find(c => c.id === s.club)?.name || '';
              const resultText = s.result.onGreen ? '온그린' : s.result.landing || '오프';
              return `✓ #${i + 1}: ${clubName}${s.distance ? ` ${s.distance}m` : ''} → ${resultText}`;
            }).join('<br>')}
          </div>
        ` : ''}

        ${needsDistance ? `
          <div class="section">
            <div class="input-section">
              <label>남은 거리 (미터)</label>
              <input type="number" class="text-input" id="distance-input"
                value="${shot.distance || ''}" 
                placeholder="예: 150">
            </div>

            ${recommendedClub ? `
              <div class="club-recommendation">
                💡 추천: ${recommendedClub.name} (평균 ${CLUB_DISTANCES[recommendedClub.id].total}m)
              </div>
            ` : ''}
          </div>
        ` : ''}

        <div class="section">
          <div class="input-section">
            <label>클럽 선택</label>
            <select class="select-input" onchange="selectClub(this.value)">
              <option value="">선택하세요</option>
              ${CLUBS.map(club => {
                const dist = CLUB_DISTANCES[club.id];
                const distText = dist.total > 0 ? ` (${dist.total}m)` : '';
                const selected = shot.club === club.id ? 'selected' : '';
                return `<option value="${club.id}" ${selected}>${club.name}${distText}</option>`;
              }).join('')}
            </select>
          </div>

          ${!isTeeShot && appState.shots.length >= 2 ? `
            <div class="input-section">
              <label>샷 타입</label>
              <div class="button-group">
                <button class="choice-btn ${shot.type === 'approach' ? 'selected' : ''}" 
                  onclick="changeShotType('approach')">
                  어프로치
                </button>
                <button class="choice-btn ${shot.type === 'short' ? 'selected' : ''}" 
                  onclick="changeShotType('short')">
                  숏게임
                </button>
              </div>
            </div>
          ` : ''}

          ${isTeeShot && isPar4or5 ? `
            <div class="input-section">
              <label>착지 지점</label>
              <div class="button-group-3">
                <button class="choice-btn ${shot.result.landing === 'fairway' ? 'selected' : ''}" 
                  onclick="setLanding('fairway')">페어웨이</button>
                <button class="choice-btn ${shot.result.landing === 'rough-left' ? 'selected' : ''}" 
                  onclick="setLanding('rough-left')">좌측 러프</button>
                <button class="choice-btn ${shot.result.landing === 'rough-right' ? 'selected' : ''}" 
                  onclick="setLanding('rough-right')">우측 러프</button>
              </div>
              <div class="button-group" style="margin-top: 8px;">
                <button class="choice-btn ${shot.result.landing === 'ob' ? 'selected' : ''}" 
                  onclick="setLanding('ob')">OB</button>
                <button class="choice-btn ${shot.result.landing === 'hazard' ? 'selected' : ''}" 
                  onclick="setLanding('hazard')">해저드</button>
              </div>
            </div>
          ` : ''}

          ${isShortGame ? `
            <div class="input-section">
              <label>위치</label>
              <div class="button-group">
                <button class="choice-btn ${shot.result.location === 'front' ? 'selected' : ''}" 
                  onclick="setLocation('front')">그린 앞</button>
                <button class="choice-btn ${shot.result.location === 'side' ? 'selected' : ''}" 
                  onclick="setLocation('side')">그린 옆</button>
              </div>
              <div class="button-group" style="margin-top: 8px;">
                <button class="choice-btn ${shot.result.location === 'bunker' ? 'selected' : ''}" 
                  onclick="setLocation('bunker')">벙커</button>
                <button class="choice-btn ${shot.result.location === 'rough' ? 'selected' : ''}" 
                  onclick="setLocation('rough')">러프</button>
              </div>
            </div>
          ` : ''}

          <div class="input-section">
            <label>구질</label>
            <div class="button-group-3">
              <button class="choice-btn ${shot.result.shape === 'straight' ? 'selected' : ''}" 
                onclick="setShape('straight')">스트레이트</button>
              <button class="choice-btn ${shot.result.shape === 'draw' ? 'selected' : ''}" 
                onclick="setShape('draw')">드로우</button>
              <button class="choice-btn ${shot.result.shape === 'fade' ? 'selected' : ''}" 
                onclick="setShape('fade')">페이드</button>
            </div>
          </div>

          ${showMissPattern ? `
            <div class="input-section">
              <label>미스 패턴 <span class="optional-label">(복수 선택 가능)</span></label>
              <div class="checkbox-group">
                ${['hook', 'slice', 'push', 'pull', 'top'].map(miss => {
                  const labels = { hook: '훅', slice: '슬라이스', push: '푸쉬', pull: '풀', top: '탑볼' };
                  const isSelected = shot.result.miss && shot.result.miss.includes(miss);
                  return `
                    <div class="checkbox-label ${isSelected ? 'selected' : ''}" 
                      onclick="toggleMiss('${miss}')">
                      ${labels[miss]}
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          ` : ''}

          ${showGreenSelection ? `
            <div class="input-section">
              <label>온그린 여부</label>
              <div class="button-group">
                <button class="choice-btn ${shot.result.onGreen === true ? 'selected' : ''}" 
                  onclick="setOnGreen(true)">온그린 ✓</button>
                <button class="choice-btn ${shot.result.onGreen === false ? 'selected' : ''}" 
                  onclick="setOnGreen(false)">그린 미스</button>
              </div>
            </div>

            ${shot.result.onGreen !== null ? `
              <div class="input-section">
                <label>${shot.result.onGreen ? '핀 위치 대비' : '결과'} <span class="optional-label">(복수 선택)</span></label>
                <div class="checkbox-group">
                  ${['short', 'long', 'left', 'right', 'within1m'].map(dir => {
                    const labels = { short: '짧음', long: '김', left: '좌측', right: '우측', within1m: '1m 이내' };
                    const isSelected = shot.result.direction && shot.result.direction.includes(dir);
                    return `
                      <div class="checkbox-label ${isSelected ? 'selected' : ''}" 
                        onclick="toggleDirection('${dir}')">
                        ${labels[dir]}
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            ` : ''}
          ` : ''}
        </div>

        <button class="primary-btn" 
          ${!canCompleteShot() ? 'disabled' : ''} 
          onclick="completeShot()">
          ${shot.result.onGreen ? '퍼팅 입력으로 →' : '다음 샷으로 →'}
        </button>
      `;

      // 거리 입력 이벤트 (onchange로 변경)
      setTimeout(() => {
        const distInput = document.getElementById('distance-input');
        if (distInput) {
          distInput.onchange = function() {
            appState.currentShot.distance = this.value;
            render();
          };
        }
      }, 0);
    }

    window.selectClub = function(clubId) {
      appState.currentShot.club = clubId;
      render();
    };

    window.changeShotType = function(type) {
      appState.currentShot.type = type;
      render();
    };

    window.setLanding = function(type) {
      appState.currentShot.result.landing = type;
      render();
    };

    window.setLocation = function(loc) {
      appState.currentShot.result.location = loc;
      render();
    };

    window.setShape = function(shape) {
      appState.currentShot.result.shape = shape;
      render();
    };

    window.toggleMiss = function(miss) {
      if (!appState.currentShot.result.miss) {
        appState.currentShot.result.miss = [];
      }
      const index = appState.currentShot.result.miss.indexOf(miss);
      if (index > -1) {
        appState.currentShot.result.miss.splice(index, 1);
      } else {
        appState.currentShot.result.miss.push(miss);
      }
      // render() 호출로 전체 화면 업데이트
      render();
    };

    window.setOnGreen = function(value) {
      appState.currentShot.result.onGreen = value;
      // 온그린 여부 변경 시 방향 초기화
      appState.currentShot.result.direction = [];
      render();
    };

    window.toggleDirection = function(dir) {
      if (!appState.currentShot.result.direction) {
        appState.currentShot.result.direction = [];
      }
      const index = appState.currentShot.result.direction.indexOf(dir);
      if (index > -1) {
        appState.currentShot.result.direction.splice(index, 1);
      } else {
        appState.currentShot.result.direction.push(dir);
      }
      // render() 호출로 전체 화면 업데이트
      render();
    };

    function canCompleteShot() {
      const shot = appState.currentShot;
      const isTeeShot = shot.type === 'tee';
      const isPar3 = appState.holePar === 3;
      const isPar4or5 = appState.holePar === 4 || appState.holePar === 5;
      const needsDistance = (isTeeShot && isPar3) || !isTeeShot;
      
      if (!shot.club) return false;
      if (needsDistance && !shot.distance) return false;
      if (isTeeShot && isPar4or5 && !shot.result.landing) return false;
      
      // Par 4/5 티샷은 온그린 체크 안 함
      const showGreenSelection = !(isTeeShot && isPar4or5);
      if (showGreenSelection && shot.result.onGreen === null) return false;
      
      return true;
    }

    window.completeShot = function() {
      if (!canCompleteShot()) return;

      // 거리 입력값 최종 반영
      const distInput = document.getElementById('distance-input');
      if (distInput) {
        appState.currentShot.distance = distInput.value;
      }

      appState.shots.push({...appState.currentShot});

      const isTeeShot = appState.currentShot.type === 'tee';
      const isPar4or5 = appState.holePar === 4 || appState.holePar === 5;

      // Par 4/5 티샷은 무조건 다음 샷으로
      if (isTeeShot && isPar4or5) {
        const nextShotNumber = appState.shots.length + 1;
        appState.currentShot = {
          number: nextShotNumber,
          type: 'approach',
          club: '',
          distance: '',
          shotType: 'approach',
          result: {
            landing: '',
            location: '',
            onGreen: null,
            direction: [],
            shape: '',
            miss: []
          }
        };
        render();
        return;
      }

      // 온그린이면 퍼팅으로
      if (appState.currentShot.result.onGreen) {
        appState.puttingData = {
          putts: 2
        };
        appState.currentShot = null;
      } else {
        // 온그린 실패면 다음 샷
        const nextShotNumber = appState.shots.length + 1;
        const lastShot = appState.shots[appState.shots.length - 1];
        
        // 샷 #3부터는 타입 선택 가능
        const shotType = appState.shots.length >= 2 ? 'approach' : 'approach';
        
        appState.currentShot = {
          number: nextShotNumber,
          type: shotType,
          club: '',
          distance: '',
          shotType: 'approach',
          result: {
            landing: '',
            location: '',
            onGreen: null,
            direction: [],
            shape: '',
            miss: []
          }
        };
      }
      
      render();
    };

    // ========================================
    // PUTTING INPUT (퍼팅 수만 입력 - 테스트1 피드백)
    // ========================================
    function renderPuttingInput(container) {
      const putting = appState.puttingData;

      container.innerHTML = `
        <div class="shot-header">
          <div class="shot-info">
            <span class="hole-num">Hole ${appState.currentHole} - Par ${appState.holePar}</span>
            <span class="tee-badge ${appState.selectedTeeBox}">
              ${appState.selectedTeeBox === 'blue' ? 'Blue' : 'White'}
            </span>
          </div>
          <div class="shot-number">⛳ 퍼팅</div>
        </div>

        ${appState.shots.length > 0 ? `
          <div class="previous-shots">
            <strong>이전 샷:</strong><br>
            ${appState.shots.map((s, i) => {
              const clubName = CLUBS.find(c => c.id === s.club)?.name || '';
              return `✓ #${i + 1}: ${clubName} → 온그린`;
            }).join('<br>')}
          </div>
        ` : ''}

        <div class="section">
          <div class="input-section">
            <label>퍼팅 수</label>
            <select class="select-input" onchange="setPuttCount(parseInt(this.value))">
              ${[1, 2, 3, 4, 5].map(n => 
                `<option value="${n}" ${putting.putts === n ? 'selected' : ''}>${n}퍼트</option>`
              ).join('')}
            </select>
          </div>
        </div>

        <button class="primary-btn" onclick="completePutting()">
          홀 완료 → 다음 홀로
        </button>
      `;
    }

    window.setPuttCount = function(count) {
      appState.puttingData.putts = count;
      render();
    };

    window.completePutting = function() {
      const totalShots = appState.shots.length + appState.puttingData.putts;
      
      const holeData = {
        number: appState.currentHole,
        par: appState.holePar,
        distance: appState.holeDistance,
        shots: [...appState.shots],
        putting: {...appState.puttingData},
        score: totalShots
      };

      appState.activeRound.holes.push(holeData);
      saveData();

      // 18홀 완료 체크
      if (appState.activeRound.holes.length >= 18) {
        finishRound();
        return;
      }

      // 다음 홀로
      appState.currentHole++;
      appState.holePar = null;
      appState.holeDistance = '';
      appState.shots = [];
      appState.currentShot = null;
      appState.puttingData = null;

      render();
    };

    // ========================================
    // ROUND SUMMARY MODAL
    // ========================================
    function renderRoundSummaryModal() {
      const modal = document.createElement('div');
      modal.className = 'modal active';
      
      const round = appState.activeRound;
      const totalScore = round.holes.reduce((sum, h) => sum + h.score, 0);
      const totalPar = round.holes.reduce((sum, h) => sum + h.par, 0);
      const scoreToPar = totalScore - totalPar;

      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">🎉 라운드 완료!</h2>
          </div>

          <div style="text-align: center; margin-bottom: 24px;">
            <div style="font-size: 48px; font-weight: 700; color: var(--green-primary);">
              ${totalScore}
            </div>
            <div style="font-size: 24px; margin-top: 8px;">
              ${scoreToPar > 0 ? '+' : ''}${scoreToPar}
            </div>
          </div>

          <div style="text-align: center; margin-bottom: 16px; opacity: 0.8;">
            ${round.course} • ${appState.selectedTeeBox === 'blue' ? '🔵 Blue' : '⚪ White'}
          </div>

          ${appState.isNewCourseRound ? `
            <div class="info-box" style="margin-bottom: 16px;">
              ✓ 새 코스가 등록되었습니다!
            </div>
          ` : ''}

          <button class="primary-btn" onclick="closeRoundSummary()">
            기록 확인하기
          </button>
        </div>
      `;

      modal.onclick = (e) => {
        if (e.target === modal) closeRoundSummary();
      };

      return modal;
    }

    window.closeRoundSummary = function() {
      appState.showRoundSummaryModal = false;
      appState.activeRound = null;
      appState.currentHole = 1;
      appState.isNewCourseRound = false;
      appState.newCourseData = null;
      appState.currentPage = 3;
      render();
    };

    // ========================================
    // STATS PAGE
    // ========================================
    function renderStatsPage(container) {
      const completedRounds = appState.data.rounds.filter(r => r.status === 'completed');
      
      if (completedRounds.length === 0) {
        container.innerHTML = `
          <h1 class="page-title">📊 통계</h1>
          <div class="empty-state">
            <p>아직 완료된 라운드가 없습니다.</p>
            <p>라운드를 완료하면 통계를 확인할 수 있습니다.</p>
          </div>
        `;
        return;
      }

      const recentRounds = completedRounds.slice(-10);
      const totalHoles = recentRounds.reduce((sum, r) => sum + r.holes.length, 0);
      
      const avgScore = (recentRounds.reduce((sum, r) => {
        return sum + r.holes.reduce((s, h) => s + h.score, 0);
      }, 0) / recentRounds.length).toFixed(1);

      // 티샷 정확도
      const teeShots = recentRounds.flatMap(r => 
        r.holes.filter(h => h.shots.length > 0).map(h => h.shots[0])
      );
      const fairwayHits = teeShots.filter(s => s.result.landing === 'fairway').length;
      const teeShotAccuracy = teeShots.length > 0 ? ((fairwayHits / teeShots.length) * 100).toFixed(0) : 0;

      // GIR
      const girCount = recentRounds.flatMap(r => r.holes).filter(h => {
        const shotsToGreen = h.shots.findIndex(s => s.result.onGreen);
        return shotsToGreen !== -1 && (shotsToGreen + 1) <= h.par - 2;
      }).length;
      const girPercentage = totalHoles > 0 ? ((girCount / totalHoles) * 100).toFixed(0) : 0;

      // 평균 퍼팅
      const totalPutts = recentRounds.reduce((sum, r) => 
        sum + r.holes.reduce((s, h) => s + (h.putting?.putts || 0), 0), 0
      );
      const avgPutts = recentRounds.length > 0 ? (totalPutts / recentRounds.length).toFixed(1) : 0;

      container.innerHTML = `
        <h1 class="page-title">📊 통계</h1>
        <p style="opacity: 0.7; margin-bottom: 8px; font-size: 13px;">최근 ${recentRounds.length}라운드</p>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">📈</div>
            <div class="stat-label">평균 스코어</div>
            <div class="stat-value">${avgScore}</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">🏌️</div>
            <div class="stat-label">티샷 정확도</div>
            <div class="stat-value">${teeShotAccuracy}%</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">🎯</div>
            <div class="stat-label">파온율 (GIR)</div>
            <div class="stat-value">${girPercentage}%</div>
          </div>
          
          <div class="stat-card">
            <div class="stat-icon">⛳</div>
            <div class="stat-label">평균 퍼팅</div>
            <div class="stat-value">${avgPutts}</div>
          </div>
        </div>

        <div class="section grow">
          <h2 class="section-title">클럽별 평균 거리</h2>
          <div class="club-list">
            ${CLUBS.filter(c => CLUB_DISTANCES[c.id].total > 0).map(club => `
              <div class="club-item">
                ${club.name}: ${CLUB_DISTANCES[club.id].total}m
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // ========================================
    // HISTORY PAGE
    // ========================================
    function renderHistoryPage(container) {
      container.classList.add('scrollable');
      const completedRounds = appState.data.rounds.filter(r => r.status === 'completed');

      if (completedRounds.length === 0) {
        container.innerHTML = `
          <h1 class="page-title">📋 기록</h1>
          <div class="empty-state">
            <p>아직 완료된 라운드가 없습니다.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = `
        <h1 class="page-title">📋 라운드 기록</h1>
        
        <div class="rounds-list">
          ${completedRounds.reverse().map(round => {
            const totalScore = round.holes.reduce((sum, h) => sum + h.score, 0);
            const totalPar = round.holes.reduce((sum, h) => sum + h.par, 0);
            const scoreToPar = totalScore - totalPar;
            const teeBox = round.teeBox === 'blue' ? '🔵' : '⚪';
            
            return `
              <div class="round-card">
                <div class="round-header-info">
                  <h3>${round.course} ${teeBox}</h3>
                  <span class="round-date">
                    ${new Date(round.date).toLocaleDateString('ko-KR')} • ${round.holes.length}홀
                  </span>
                </div>
                <div class="round-score-info">
                  <div class="total-score">${totalScore}</div>
                  <div style="font-size: 16px; color: var(--brown); opacity: 0.7;">
                    ${scoreToPar > 0 ? `+${scoreToPar}` : scoreToPar}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    // ========================================
    // SCORECARD PROXY (server address helpers)
    // ========================================
    function _normalizeUrl(url) {
      return (url || '').trim().replace(/\/+$/, '');
    }

    function getScorecardServerDisplay() {
      return FIXED_SCORECARD_PROXY + ' (고정)';
    }

    window.viewScorecardServer = function() {
      alert('현재 스코어카드 서버 주소:\n' + getScorecardServerDisplay());
    };

    


    // ========================================
    // SETTINGS PAGE
    // ========================================
    function renderSettingsPage(container) {
      container.classList.add('scrollable');
      container.innerHTML = `
        <h1 class="page-title">⚙️ 설정</h1>
        
        
        <div class="section">
          <h2 class="section-title">스코어카드 분석 서버</h2>
          <p style="margin-bottom: 12px; opacity: 0.8;">
            현재 서버: <b>${getScorecardServerDisplay()}</b>
          </p>

          <div class="button-group">
            <button class="secondary-btn" onclick="viewScorecardServer()">서버 주소 보기</button>
          </div>

          <p style="opacity: 0.55; font-size: 12px; margin-top: 10px; line-height: 1.4;">
            • 이 서버는 Render에 배포된 공식 프록시이며 변경할 수 없습니다.<br>
            • GitHub Pages 전용으로 최적화되어 있습니다.
          </p>
        </div>

<div class="section">
          <h2 class="section-title">등록된 코스 관리</h2>
          <p style="margin-bottom: 16px; opacity: 0.8;">
            총 ${appState.data.courses.length}개 코스 등록됨
          </p>
          
          ${appState.data.courses.map(course => {
            const totalPar = course.par.reduce((a,b) => a+b, 0);
            return `
              <div class="course-btn" style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                <div class="course-info">
                  <div class="course-name">${course.name}</div>
                  <div class="course-details">${course.location || '위치 미등록'} • ${course.holes}홀 • Par ${totalPar}</div>
                </div>
                <div class="btn-group">
                  <button class="edit-btn" onclick="openCourseEdit('${course.id}')">수정</button>
                  <button class="delete-btn" onclick="deleteCourse('${course.id}')">삭제</button>
                </div>
              </div>
            `;
          }).join('')}
          
          <button class="secondary-btn" onclick="openCourseRegistration()">
            ➕ 새 코스 등록하기
          </button>
        </div>

        <div class="section">
          <h2 class="section-title">골프백 구성 & 거리 정보</h2>
          <div class="club-list">
            ${CLUBS.map(club => {
              const dist = CLUB_DISTANCES[club.id];
              const distText = dist && dist.total > 0 ? ` (${dist.total}m)` : '';
              return `
                <div class="club-item">✓ ${club.name}${distText}</div>
              `;
            }).join('')}
          </div>
        </div>

        <div class="section">
          <h2 class="section-title">데이터</h2>
          <p style="margin-bottom: 12px; opacity: 0.8;">
            총 ${appState.data.rounds.length}개 라운드 기록
          </p>
          <button class="primary-btn" style="background: var(--red);" onclick="clearAllData()">
            모든 데이터 삭제
          </button>
        </div>

        <div class="section" style="text-align: center;">
          <h3 style="margin-bottom: 8px;">Golf Round Analyzer</h3>
          <p style="opacity: 0.6;">Version 9.2.0</p>
          <p style="opacity: 0.6;">테스트2 피드백 반영</p>
          <p style="opacity: 0.6; font-size: 12px; margin-top: 8px;">
            Par 입력 로직 개선 • 샷 필드 초기화 수정
          </p>
        </div>
      `;
    }

    window.deleteCourse = function(courseId) {
      if (confirm('이 코스를 삭제하시겠습니까?')) {
        appState.data.courses = appState.data.courses.filter(c => c.id !== courseId);
        saveData();
        render();
      }
    };

    window.clearAllData = function() {
      if (confirm('모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
        appState.data = { rounds: [], courses: [...DEFAULT_COURSES] };
        saveData();
        alert('모든 데이터가 삭제되었습니다.');
        render();
      }
    };

    // ========================================
    // PAGE ROUTING (for new course flow)
    // ========================================
    function renderByPage(container) {
      switch (appState.currentPage) {
        case 10: renderExistingCourseSelectionPage(container); break;
        case 11: renderNewCourseInputPage(container); break;
        case 12: renderTeeboxSelectionPage(container); break;
        default:
          render();
      }
    }

    // Override render for page routing
    const originalRender = render;
    render = function() {
      if (appState.currentPage >= 10 && appState.currentPage <= 12 && !appState.activeRound) {
        const app = document.getElementById('app');
        app.innerHTML = '';
        const container = document.createElement('div');
        container.className = 'page-container';
        renderByPage(container);
        app.appendChild(container);
        if (appState.currentPage !== 0) app.appendChild(renderBottomNav());
      } else {
        originalRender();
      }
    };


    // ========================================
    // SCORECARD UPLOAD (via Proxy Server)
    // ========================================
    // ✅ GitHub Pages(프론트)에는 API Key를 두지 않습니다.
    // ✅ Node.js 서버(프록시)에서만 GEMINI_API_KEY를 사용합니다.

    const SCORECARD_PROXY_STORAGE_KEY = 'golf_analyzer_scorecard_proxy_base_url';
    const FIXED_SCORECARD_PROXY = 'https://golf-analyzer-xtxv.onrender.com';

    function normalizeBaseUrl(url) {
      return (url || '').trim().replace(/\/+$/, '');
    }

    function getScorecardProxyBaseUrl() {
      // 🔒 고정된 공식 서버 사용 (변경 불가)
      localStorage.setItem(SCORECARD_PROXY_STORAGE_KEY, FIXED_SCORECARD_PROXY);
      return FIXED_SCORECARD_PROXY;
    }

    // 필요 시 주소를 다시 입력하도록 초기화
    

    window.uploadCamera = function() {
      document.getElementById('scorecard-camera').click();
    };

    window.uploadGallery = function() {
      document.getElementById('scorecard-upload').click();
    };

    window.handleScoreCardUpload = async function(event) {
      const file = event.target.files[0];
      if (!file) return;
      event.target.value = '';

      const proxyBaseUrl = getScorecardProxyBaseUrl();
      if (!proxyBaseUrl) {
        alert('❌ 스코어카드 처리 실패:\n서버 주소가 입력되지 않았습니다.');
        return;
      }

      document.getElementById('upload-loading').classList.add('active');

      try {
        const base64Data = await fileToBase64(file);
        const mimeType = file.type || 'image/jpeg';

        const extractedData = await callScorecardProxy(proxyBaseUrl, base64Data, mimeType);
        fillCourseFromAI(extractedData);

      } catch (error) {
        console.error('Scorecard error:', error);
        alert('❌ 스코어카드 처리 실패:\n' + (error && error.message ? error.message : String(error)));
      } finally {
        document.getElementById('upload-loading').classList.remove('active');
      }
    };

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(String(reader.result).split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function callScorecardProxy(proxyBaseUrl, base64Data, mimeType) {
      const url = proxyBaseUrl + '/api/scorecard';

      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ base64Data, mimeType })
      });

      if (!response.ok) {
        const errText = await response.text();

        // 404/405는 보통 "서버 주소/엔드포인트가 다름" 또는 "GET/POST 불일치" 케이스가 많음
        if (response.status === 404 || response.status === 405) {
          throw new Error(`프록시 호출 실패: ${response.status}\n요청 URL: ${url}\n\n서버 주소가 잘못되었거나, 서버가 /api/scorecard POST를 지원하지 않습니다.\n설정(⚙️) → 스코어카드 분석 서버에서 주소를 확인 후 다시 시도하세요.\n\n${errText ? ('서버 응답: ' + errText) : ''}`);
        }

        throw new Error('프록시 호출 실패: ' + response.status + ' ' + errText);
      }

      // 서버는 최종 JSON(코스 정보)을 반환해야 합니다.
      return await response.json();
    }

function fillCourseFromAI(data) {
  const holes = data.holes || 18;
  let par = data.par || [];
  let distBlue = data.distances_blue || [];
  let distWhite = data.distances_white || [];

  // ✅ Stroke Index(또는 Handicap 열) 후보 키들
  const rawIdx =
    data.stroke_index ??
    data.strokeIndex ??
    data.stroke_index_mens ??
    data.index ??
    data.mens_index ??
    data.mensIndex ??
    data.mens_hcp ??
    data.mensHcp ??
    data.mens_hdcp ??
    data.mensHdcp ??
    data.handicap ??
    data.hcp ??
    data.hdc ??
    data.hdcp ??
    data.mens_handicap ??
    data.mensHandicap ??
    [];

  // ✅ 다양한 형태(배열/문자열/객체 out+in)를 1개의 배열로 정규화
  let strokeIdx = [];
  if (Array.isArray(rawIdx)) {
    strokeIdx = rawIdx;
  } else if (rawIdx && typeof rawIdx === 'object') {
    // 예: { out:[...], in:[...] } 또는 { front9:[...], back9:[...] }
    const outArr = rawIdx.out || rawIdx.front9 || rawIdx.front_9 || rawIdx.out9 || rawIdx.out_9 || [];
    const inArr = rawIdx.in || rawIdx.back9 || rawIdx.back_9 || rawIdx.in9 || rawIdx.in_9 || [];
    if (Array.isArray(outArr) || Array.isArray(inArr)) {
      strokeIdx = []
        .concat(Array.isArray(outArr) ? outArr : [])
        .concat(Array.isArray(inArr) ? inArr : []);
    }
  } else if (typeof rawIdx === 'string') {
    // 예: "5,11,7,15,1,..." 또는 "5 11 7 ..."
    const nums = rawIdx.match(/\d+/g);
    strokeIdx = nums ? nums.map(n => parseInt(n, 10)) : [];
  }

  // 길이 보정(기본값 적용)
  while (par.length < holes) par.push(4);
  while (distBlue.length < holes) distBlue.push(0);
  while (distWhite.length < holes) distWhite.push(0);
  if (!Array.isArray(strokeIdx)) strokeIdx = [];
  while (strokeIdx.length < holes) strokeIdx.push(strokeIdx.length + 1);

  appState.newCourse = {
    id: 'course_' + Date.now(),
    name: data.name || '',
    location: data.location || '',
    holes: holes,
    par: par.slice(0, holes),
    strokeIndex: strokeIdx.slice(0, holes),
    distances: {
      blue: distBlue.slice(0, holes),
      white: distWhite.slice(0, holes)
    }
  };
  appState.showCourseModal = true;
  render();
}

    // ========================================
    // INIT
    // ========================================
    loadData();
    render();
  </script>
</body>
</html>
<!-- test -->




